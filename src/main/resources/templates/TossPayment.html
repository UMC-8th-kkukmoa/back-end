<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>토스 결제</title>
    <!-- 토스페이먼츠 결제창 SDK (v2 / 위젯) -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>
<style>
    .w-100 {
        width: 100%;
    }

    .h-100 {
        height: 100%;
    }

    a {
        text-decoration: none;
        text-align: center;
    }

    .wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 24px;
        overflow: auto;
    }

    .max-w-540 {
        max-width: 540px;
    }

    .btn-wrapper {
        padding: 0 24px;
    }

    .btn {
        padding: 11px 22px;
        border: none;
        border-radius:  8px;

        background-color: #f2f4f6;
        color: #4e5968;
        font-weight: 600;
        font-size: 17px;
        cursor: pointer;
    }

    .btn.primary {
        background-color: #3282f6;
        color: #f9fcff;
    }

    .text-center {
        text-align: center;
    }

    .flex {
        display: flex;
    }

    .flex-column {
        display: flex;
        flex-direction: column;
    }

    .justify-center {
        justify-content: center;
    }

    .justify-between {
        justify-content: space-between;
    }

    .align-center {
        align-items: center;
    }

    .confirm-loading {
        margin-top: 72px;
        height: 400px;
        justify-content: space-between;
    }


    .confirm-success {
        display: none;
        margin-top: 72px;
    }

    .button-group {
        margin-top: 32px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 16px;
    }

    .title {
        margin-top: 32px;
        margin-bottom: 0;
        color: #191f28;
        font-weight: bold;
        font-size: 24px;
    }

    .description {
        margin-top: 8px;
        color: #4e5968;
        font-size: 17px;
        font-weight: 500;
    }

    .response-section {
        margin-top: 60px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        font-size: 20px;
    }

    .response-section .response-label {
        font-weight: 600;
        color: #333d48;
        font-size: 17px;
    }

    .response-section .response-text {
        font-weight: 500;
        color: #4e5968;
        font-size: 17px;
        padding-left: 16px;
        word-break: break-word;
        text-align: right;
    }

    .color-grey {
        color: #b0b8c1;
    }
</style>
<body>
<!-- 할인 쿠폰 -->


<!-- 결제 UI -->
<div id="payment-method"></div>
<div id="agreement"></div>

<!-- 결제하기 버튼 -->
<button class="btn primary w-100" id="payment-button" style="margin-top: 30px;">결제하기</button>

<script th:inline="javascript">
    const token = /*[[${token}]]*/ "";
    const unitPrice = /*[[${unitPrice}]]*/ 0;
    const quantity  = /*[[${quantity}]]*/ 0;

    if (token) {
        localStorage.setItem("kkukmoa_token", token);
    }

    main();

    async function main() {
        const button = document.getElementById("payment-button");
        const baseAmount = unitPrice * quantity;

        const clientKey = /*[[${clientKey}]]*/ "";
        const tossPayments = TossPayments(clientKey);

        // customerKey 생성
        const customerKey = await fetch("https://kkukmoa.shop/v1/users/uuid", {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        })
            .then(res => res.json())
            .then(data => "user_" + data.result)
            .catch(err => {
                console.error(err);
                alert("사용자 정보를 불러오지 못했습니다.");
                return null;
            });

        if (!customerKey) return;

        const widgets = tossPayments.widgets({ customerKey });

        await widgets.setAmount({ currency: "KRW", value: baseAmount });

        await Promise.all([
            widgets.renderPaymentMethods({ selector: "#payment-method", variantKey: "DEFAULT" }),
            widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" }),
        ]);

        // 결제 요청
        button.addEventListener("click", async function () {
            const prepareRes = await fetch("https://kkukmoa.shop/v1/payments/prepare", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                    orderName: `꾹모아 금액권 ${unitPrice}원권`,
                    amount: baseAmount,
                    voucherUnitPrice: unitPrice,
                    voucherQuantity: quantity
                }),
            });

            if (!prepareRes.ok) {
                alert("결제 사전 준비 실패");
                return;
            }

            const prepareData = await prepareRes.json();

            await widgets.setAmount({ currency: "KRW", value: prepareData.amount ?? baseAmount });

            await widgets.requestPayment({
                orderId: prepareData.orderId,
                orderName: prepareData.orderName,
                successUrl: `${window.location.origin}${window.location.pathname}?orderId=${prepareData.orderId}&amount=${prepareData.amount}&token=${encodeURIComponent(token)}&unitPrice=${unitPrice}&quantity=${quantity}`,
                failUrl: `${window.location.href}?fail=true`
            });

        });

        // 결제 승인 처리
        const params = new URLSearchParams(window.location.search);
        const paymentKey = params.get("paymentKey");
        const orderId = params.get("orderId");
        const amount = parseInt(params.get("amount") || "0", 10);
        const unitPriceParam = parseInt(params.get("unitPrice") || "0", 10);
        const quantityParam = parseInt(params.get("quantity") || "1", 10);

// token 확보 우선순위: 쿼리 → sessionStorage → localStorage
        const tokenParam = params.get("token");
        const tokenFromStorage = sessionStorage.getItem("kkukmoa_token") || localStorage.getItem("kkukmoa_token");
        const tokenToUse = tokenParam || tokenFromStorage;

        if (paymentKey && orderId && amount && tokenToUse) {
            console.log("결제 승인 요청:", tokenToUse);

            const confirmRes = await fetch("https://kkukmoa.shop/v1/payments/confirm", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${tokenToUse}`
                },
                body: JSON.stringify({
                    paymentKey,
                    orderId,
                    amount,
                    voucherUnitPrice: unitPriceParam,
                    voucherQuantity: quantityParam
                })
            });

            const confirmJson = await confirmRes.json();

            if (!confirmRes.ok) {
                console.error("결제 승인 실패:", confirmJson.message);
                alert("결제 승인 실패: " + confirmJson.message);
                return;
            }

            console.log("결제 승인 성공:", confirmJson);
            window.location.href = "kkukmoa://app/myGiftCard/MyGiftCardList";
        } else if (!tokenToUse) {
            console.error("토큰 누락으로 결제 승인 불가");
            alert("인증 정보가 만료되었거나 누락되어 결제 승인을 진행할 수 없습니다.");
        }
    }

</script>

</body>
</html>
