<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>토스 결제</title>
    <!-- 토스페이먼츠 결제창 SDK (v2 / 위젯) -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>
<body>
<!-- 할인 쿠폰 -->
<div>
    <input type="checkbox" id="coupon-box" />
    <label for="coupon-box"> 5,000원 쿠폰 적용 </label>
</div>

<!-- 결제 UI -->
<div id="payment-method"></div>
<div id="agreement"></div>

<!-- 결제하기 버튼 -->
<button class="button" id="payment-button" style="margin-top: 30px">결제하기</button>

<script th:inline="javascript">
    const token = /*[[${token}]]*/ "";
    main();

    async function main() {
        const button = document.getElementById("payment-button");
        const coupon = document.getElementById("coupon-box");

        const unitPrice = 200;
        const quantity = 2;
        const baseAmount = unitPrice * quantity;

        const clientKey = /*[[${clientKey}]]*/ "";
        const tossPayments = TossPayments(clientKey);
        const customerKey = await fetch("/v1/users/uuid", {
            method: "GET",
            headers: { "Authorization": token }
        })
            .then(res => {
                if (!res.ok) throw new Error("UUID 가져오기 실패");
                return res.json();
            })
            .then(data => {
                const uuid = data.result;
                return "user_" + uuid;
            })
            .catch(err => {
                console.error(err);
                alert("사용자 정보를 불러오지 못했습니다.");
                return null;
            });

        if (!customerKey) return;

        const widgets = tossPayments.widgets({ customerKey: customerKey });




        await widgets.setAmount({ currency: "KRW", value: baseAmount });

        await Promise.all([
            widgets.renderPaymentMethods({ selector: "#payment-method", variantKey: "DEFAULT" }),
            widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" }),
        ]);

        coupon.addEventListener("change", async function () {
            const discount = coupon.checked ? 5000 : 0;
            const newAmount = Math.max(0, baseAmount - discount);
            await widgets.setAmount({ currency: "KRW", value: newAmount });
        });



        button.addEventListener("click", async function () {
            const discount = coupon.checked ? 5000 : 0;
            const amount = Math.max(0, unitPrice * quantity - discount);

            const prepareRes = await fetch("/v1/payments/prepare", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": token
                },
                body: JSON.stringify({
                    orderName: `꾹모아 금액권 ${unitPrice}원`,
                    amount: amount,
                    voucherUnitPrice: unitPrice,
                    voucherQuantity: quantity
                }),
            });

            if (!prepareRes.ok) {
                const errTxt = await prepareRes.text();
                alert("결제 사전 준비 실패: " + errTxt);
                return;
            }

            const prepareData = await prepareRes.json();
            const orderId = prepareData.orderId;
            const finalName = prepareData.orderName ?? `금액권 ${unitPrice}원 × ${quantity}장`;

            await widgets.setAmount({ currency: "KRW", value: prepareData.amount ?? amount });

            await widgets.requestPayment({
                orderId: orderId,
                orderName: finalName,
                successUrl: window.location.href,
                failUrl: window.location.href + "?fail=true",
                customerEmail: "customer123@gmail.com",
                customerName: "김토스",
                customerMobilePhone: "01012341234",
            });
        });


        const params = new URLSearchParams(window.location.search);
        const paymentKey = params.get("paymentKey");
        const orderId = params.get("orderId");
        const amount = parseInt(params.get("amount") || "0", 10);

        if (paymentKey && orderId && amount) {


            const confirmRes = await fetch("/v1/payments/confirm", {
                method: "POST",
                headers: {
                    "Authorization": token,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    paymentKey: paymentKey,
                    orderId: orderId,
                    amount: amount,
                    voucherUnitPrice: unitPrice,
                    voucherQuantity: quantity
                }),
            });

            const confirmJson = await confirmRes.json();

            if (!confirmRes.ok) {
                console.error("결제 승인 실패:", confirmJson.message);
                return;
            }

            console.log("결제 승인 성공:", confirmJson);
            window.location.href = "kkukmoa://app/myGiftCard/MyGiftCardList";
        }
    }
</script>
</body>
</html>
